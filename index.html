<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RadioFinder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0f0f0f;
            color: white;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        .radio-player {
            background: #1a1a1a;
            border-radius: 0;
            padding: 12px; /* Ridotto padding generale */
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 100%;
            margin: 0;
            box-shadow: none;
            border: none;
            height: 100vh;
            overflow: hidden;
        }

        .station-info {
            text-align: center;
            margin-bottom: 10px; /* Ridotto margine */
            flex-shrink: 0;
            position: relative;
            padding: 8px 0; /* Padding ridotto */
        }

        .station-name {
            font-size: 1.1em; /* Font ridotto */
            font-weight: 600;
            margin-bottom: 3px; /* Margine ridotto */
            line-height: 1.2;
        }

        .station-details {
            font-size: 0.8em; /* Font ridotto */
            color: #888;
            margin-bottom: 5px; /* Margine ridotto */
            line-height: 1.2;
        }

        .now-playing {
            font-size: 0.75em; /* Font ridotto */
            color: #ff2a6d;
            font-style: italic;
            min-height: 16px; /* Altezza ridotta */
            margin-bottom: 3px; /* Margine ridotto */
            line-height: 1.2;
        }

        .status {
            font-size: 0.8em; /* Font ridotto */
            color: #ff2a6d;
            min-height: 18px; /* Altezza ridotta */
            flex-shrink: 0;
            text-align: center;
            line-height: 1.2;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px; /* Gap ridotto */
            margin-bottom: 10px; /* Margine ridotto */
            flex-shrink: 0;
            padding: 5px 0; /* Padding ridotto */
        }

        .control-btn {
            width: 50px; /* Dimensione ridotta */
            height: 50px; /* Dimensione ridotta */
            border-radius: 50%;
            border: none;
            background: #ff2a6d;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1em; /* Font ridotto */
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: #ff1a5d;
            transform: scale(1.05);
        }

        .control-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .stop-btn {
            width: 40px; /* Dimensione ridotta */
            height: 40px; /* Dimensione ridotta */
            border-radius: 50%;
            border: none;
            background: #333;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em; /* Font ridotto */
            transition: all 0.3s ease;
        }

        .stop-btn:hover {
            background: #444;
        }

        .stop-btn:disabled {
            background: #222;
            color: #666;
            cursor: not-allowed;
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 10px; /* Gap ridotto */
            margin-bottom: 10px; /* Margine ridotto */
            flex-shrink: 0;
            padding: 3px 0; /* Padding ridotto */
        }

        .volume-slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            background: #333;
            border-radius: 2px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px; /* Dimensione ridotta */
            height: 14px; /* Dimensione ridotta */
            border-radius: 50%;
            background: #ff2a6d;
            cursor: pointer;
        }

        .counter {
            text-align: center;
            font-size: 0.75em; /* Font ridotto */
            color: #888;
            margin-bottom: 8px; /* Margine ridotto */
            flex-shrink: 0;
            line-height: 1.2;
        }

        .progress {
            width: 100%;
            height: 3px; /* Altezza ridotta */
            background: #333;
            border-radius: 2px;
            margin: 8px 0; /* Margine ridotto */
            overflow: hidden;
            flex-shrink: 0;
        }

        .progress-bar {
            height: 100%;
            background: #ff2a6d;
            transition: width 0.3s ease;
            width: 0%;
        }

        .search-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            margin-bottom: 10px; /* Margine ridotto */
        }

        .search-header {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px; /* Gap ridotto */
            margin-bottom: 10px; /* Margine ridotto */
            flex-shrink: 0;
        }

        .search-box {
            padding: 10px 14px; /* Padding ridotto */
            border-radius: 8px; /* Border radius ridotto */
            border: 1px solid #333;
            background: #252525;
            color: white;
            font-size: 0.9em; /* Font ridotto */
            outline: none;
        }

        .load-more-btn {
            padding: 6px 10px; /* Padding ridotto */
            background: #333;
            color: white;
            border: none;
            border-radius: 8px; /* Border radius ridotto */
            cursor: pointer;
            white-space: nowrap;
            font-size: 1.1em; /* Font ridotto */
            width: 45px; /* Larghezza ridotta */
            height: 40px; /* Altezza ridotta */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .load-more-btn:hover {
            background: #444;
        }

        .load-more-btn:disabled {
            background: #222;
            color: #666;
            cursor: not-allowed;
        }

        .station-list {
            flex: 1;
            overflow-y: auto;
            border-radius: 8px; /* Border radius ridotto */
            background: #252525;
            margin-bottom: 8px; /* Margine ridotto */
        }

        .station-item {
            padding: 10px 14px; /* Padding ridotto */
            border-bottom: 1px solid #333;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .station-item:hover {
            background: #333;
        }

        .station-item:last-child {
            border-bottom: none;
        }

        .station-item-info {
            flex: 1;
        }

        .station-item-name {
            font-weight: 500;
            margin-bottom: 3px; /* Margine ridotto */
            font-size: 0.9em; /* Font ridotto */
            line-height: 1.2;
        }

        .station-item-details {
            font-size: 0.75em; /* Font ridotto */
            color: #888;
            line-height: 1.2;
        }

        .visualizer-container {
            height: 60px; /* Altezza ridotta */
            margin-bottom: 10px; /* Margine ridotto */
            border-radius: 8px; /* Border radius ridotto */
            background: #0a0a0a;
            overflow: hidden;
            display: none;
            flex-shrink: 0;
            cursor: pointer;
            position: relative;
        }

        .visualizer {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 2px;
            padding: 8px; /* Padding ridotto */
            position: relative;
        }

        .visualizer-bar {
            width: 6px; /* Larghezza ridotta */
            background: linear-gradient(to top, #ff2a6d, #ff8e53);
            border-radius: 3px 3px 0 0; /* Border radius ridotto */
            transition: height 0.1s ease;
        }

        .visualizer-circle {
            width: 10px; /* Dimensione ridotta */
            height: 10px; /* Dimensione ridotta */
            border-radius: 50%;
            background: #ff2a6d;
            position: absolute;
            transition: all 0.1s ease;
        }

        /* Resto degli stili del visualizzatore rimangono invariati ma con dimensioni ridotte */
        .visualizer-wave {
            width: 100%;
            height: 25%; /* Altezza ridotta */
            background: linear-gradient(90deg, transparent, #ff2a6d, transparent);
            opacity: 0.7;
            position: absolute;
            bottom: 0;
            transform-origin: center bottom;
        }

        .visualizer-particle {
            width: 5px; /* Dimensione ridotta */
            height: 5px; /* Dimensione ridotta */
            border-radius: 50%;
            background: #ff2a6d;
            position: absolute;
            bottom: 0;
        }

        .visualizer-spectrum {
            width: 100%;
            height: 100%;
            background: linear-gradient(to top, #ff2a6d, #ff8e53, #ffd166);
            position: absolute;
            bottom: 0;
            transform-origin: bottom;
            transition: height 0.2s ease;
        }

        .visualizer-line {
            width: 100%;
            height: 2px;
            background: #ff2a6d;
            position: absolute;
            left: 0;
            transition: transform 0.1s ease;
        }

        .visualizer-square {
            width: 12px; /* Dimensione ridotta */
            height: 12px; /* Dimensione ridotta */
            background: #ff2a6d;
            position: absolute;
            transition: all 0.1s ease;
        }

        .visualizer-triangle {
            width: 0;
            height: 0;
            border-left: 6px solid transparent; /* Dimensione ridotta */
            border-right: 6px solid transparent; /* Dimensione ridotta */
            border-bottom: 11px solid #ff2a6d; /* Dimensione ridotta */
            position: absolute;
            transition: all 0.1s ease;
        }

        .visualizer-dot {
            width: 3px; /* Dimensione ridotta */
            height: 3px; /* Dimensione ridotta */
            border-radius: 50%;
            background: #ff2a6d;
            position: absolute;
            transition: all 0.1s ease;
        }

        .visualizer-ring {
            width: 16px; /* Dimensione ridotta */
            height: 16px; /* Dimensione ridotta */
            border-radius: 50%;
            border: 2px solid #ff2a6d;
            position: absolute;
            transition: all 0.1s ease;
        }

        .visualizer-spiral {
            width: 8px; /* Dimensione ridotta */
            height: 8px; /* Dimensione ridotta */
            border-radius: 50%;
            background: #ff2a6d;
            position: absolute;
            transition: all 0.2s ease;
        }

        .visualizer-arc {
            width: 16px; /* Dimensione ridotta */
            height: 16px; /* Dimensione ridotta */
            border-radius: 50%;
            border: 2px solid transparent;
            border-top: 2px solid #ff2a6d;
            position: absolute;
            transition: all 0.1s ease;
        }

        .visualizer-hexagon {
            width: 13px; /* Dimensione ridotta */
            height: 11px; /* Dimensione ridotta */
            background: #ff2a6d;
            position: absolute;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            transition: all 0.1s ease;
        }

        .visualizer-diamond {
            width: 10px; /* Dimensione ridotta */
            height: 10px; /* Dimensione ridotta */
            background: #ff2a6d;
            position: absolute;
            transform: rotate(45deg);
            transition: all 0.1s ease;
        }

        .visualizer-star {
            width: 13px; /* Dimensione ridotta */
            height: 13px; /* Dimensione ridotta */
            background: #ff2a6d;
            position: absolute;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            transition: all 0.1s ease;
        }

        .visualizer-pulse {
            width: 8px; /* Dimensione ridotta */
            height: 8px; /* Dimensione ridotta */
            border-radius: 50%;
            background: #ff2a6d;
            position: absolute;
            transition: all 0.1s ease;
        }

        .visualizer-grid {
            width: 8px; /* Dimensione ridotta */
            height: 8px; /* Dimensione ridotta */
            background: #ff2a6d;
            position: absolute;
            transition: all 0.1s ease;
        }

        .visualizer-radial {
            width: 100%;
            height: 100%;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .visualizer-radial-line {
            width: 2px;
            height: 16px; /* Altezza ridotta */
            background: #ff2a6d;
            position: absolute;
            transform-origin: bottom center;
            transition: height 0.1s ease;
        }

        .visualizer-matrix {
            width: 6px; /* Dimensione ridotta */
            height: 6px; /* Dimensione ridotta */
            background: #ff2a6d;
            position: absolute;
            transition: all 0.1s ease;
        }

        .visualizer-vortex {
            width: 8px; /* Dimensione ridotta */
            height: 8px; /* Dimensione ridotta */
            border-radius: 50%;
            background: #ff2a6d;
            position: absolute;
            transition: all 0.2s ease;
        }

        .visualizer-ripple {
            width: 8px; /* Dimensione ridotta */
            height: 8px; /* Dimensione ridotta */
            border-radius: 50%;
            border: 1px solid #ff2a6d;
            position: absolute;
            transition: all 0.2s ease;
        }

        .visualizer-firework {
            width: 3px; /* Dimensione ridotta */
            height: 3px; /* Dimensione ridotta */
            border-radius: 50%;
            background: #ff2a6d;
            position: absolute;
            transition: all 0.1s ease;
        }

        .visualizer-nebula {
            width: 100%;
            height: 100%;
            position: absolute;
            background: radial-gradient(circle, transparent 10%, #0a0a0a 70%);
        }

        .station-list::-webkit-scrollbar {
            width: 5px; /* Larghezza ridotta */
        }

        .station-list::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .station-list::-webkit-scrollbar-thumb {
            background: #ff2a6d;
            border-radius: 2px; /* Border radius ridotto */
        }
    </style>
</head>
<body>
    <div class="radio-player">
        <div class="station-info">
            <div class="station-name">Seleziona una stazione</div>
            <div class="station-details">Caricamento in corso...</div>
            <div class="now-playing" id="nowPlaying"></div>
            <div class="status" id="status">Preparazione...</div>
        </div>
        
        <div class="controls">
            <button class="control-btn" id="playPause" disabled>‚ñ∂</button>
            <button class="stop-btn" id="stopBtn" disabled>‚èπ</button>
        </div>

        <div class="volume-container">
            <span>üîä</span>
            <input type="range" class="volume-slider" id="volume" min="0" max="1" step="0.1" value="0.5">
        </div>

        <div class="visualizer-container" id="visualizerContainer">
            <div class="visualizer" id="visualizer"></div>
        </div>

        <div class="counter">
            Caricate: <span id="stationCount">0</span> di 20000+ Stazioni
        </div>

        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="search-container">
            <div class="search-header">
                <input type="text" class="search-box" id="searchInput" placeholder="üîç Cerca stazioni radio...">
                 <button class="load-more-btn" id="loadMore" disabled>üîç+</button>
            </div>
            <div class="station-list" id="stationList"></div>
        </div>
    </div>

    <script>
        // Il resto del codice JavaScript rimane invariato
        // Configurazione
        const TARGET_STATIONS = 20000;
        const BATCH_SIZE = 1000;

        // Elementi DOM
        const audio = new Audio();
        const playPauseBtn = document.getElementById('playPause');
        const stopBtn = document.getElementById('stopBtn');
        const volumeSlider = document.getElementById('volume');
        const searchInput = document.getElementById('searchInput');
        const stationList = document.getElementById('stationList');
        const loadMoreBtn = document.getElementById('loadMore');
        const stationName = document.querySelector('.station-name');
        const stationDetails = document.querySelector('.station-details');
        const statusEl = document.getElementById('status');
        const nowPlayingEl = document.getElementById('nowPlaying');
        const stationCountEl = document.getElementById('stationCount');
        const progressBar = document.getElementById('progressBar');
        const visualizerContainer = document.getElementById('visualizerContainer');
        const visualizer = document.getElementById('visualizer');

        // Variabili globali
        let currentStation = null;
        let isPlaying = false;
        let allStations = [];
        let loadedCount = 0;
        let currentOffset = 0;
        let isLoading = false;
        let currentSearchQuery = '';
        let visualizerAnimationId = null;
        let currentVisualizerType = 0;
        const visualizerTypes = 25;
        let nowPlayingInterval = null;

        // Inizializza il visualizzatore
        function initVisualizer() {
            // Rimuovi elementi esistenti
            visualizer.innerHTML = '';
            
            if (currentVisualizerType === 0) {
                // Visualizzatore a barre
                for (let i = 0; i < 32; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'visualizer-bar';
                    bar.style.height = '5px';
                    visualizer.appendChild(bar);
                }
            } else if (currentVisualizerType === 1) {
                // Visualizzatore a cerchi
                for (let i = 0; i < 24; i++) {
                    const circle = document.createElement('div');
                    circle.className = 'visualizer-circle';
                    const angle = (i / 24) * Math.PI * 2;
                    const radius = 30;
                    const x = 50 + radius * Math.cos(angle);
                    const y = 50 + radius * Math.sin(angle);
                    circle.style.left = `${x}%`;
                    circle.style.top = `${y}%`;
                    visualizer.appendChild(circle);
                }
            } else if (currentVisualizerType === 2) {
                // Visualizzatore a onde
                for (let i = 0; i < 3; i++) {
                    const wave = document.createElement('div');
                    wave.className = 'visualizer-wave';
                    wave.style.height = `${20 + i * 15}%`;
                    wave.style.background = `linear-gradient(90deg, transparent, ${i === 0 ? '#ff2a6d' : i === 1 ? '#ff8e53' : '#ffd166'}, transparent)`;
                    visualizer.appendChild(wave);
                }
            } else if (currentVisualizerType === 3) {
                // Visualizzatore a particelle
                for (let i = 0; i < 40; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'visualizer-particle';
                    particle.style.left = `${Math.random() * 100}%`;
                    particle.style.bottom = `${Math.random() * 100}%`;
                    particle.style.background = `hsl(${Math.random() * 60 + 330}, 100%, 65%)`;
                    visualizer.appendChild(particle);
                }
            } else if (currentVisualizerType === 4) {
                // Visualizzatore spectrum
                const spectrum = document.createElement('div');
                spectrum.className = 'visualizer-spectrum';
                spectrum.style.height = '10%';
                visualizer.appendChild(spectrum);
            } else if (currentVisualizerType === 5) {
                // Linee orizzontali
                for (let i = 0; i < 12; i++) {
                    const line = document.createElement('div');
                    line.className = 'visualizer-line';
                    line.style.top = `${(i / 12) * 100}%`;
                    line.style.transform = `scaleX(0.1)`;
                    visualizer.appendChild(line);
                }
            } else if (currentVisualizerType === 6) {
                // Quadrati
                for (let i = 0; i < 20; i++) {
                    const square = document.createElement('div');
                    square.className = 'visualizer-square';
                    square.style.left = `${Math.random() * 100}%`;
                    square.style.top = `${Math.random() * 100}%`;
                    square.style.background = `hsl(${Math.random() * 360}, 100%, 65%)`;
                    visualizer.appendChild(square);
                }
            } else if (currentVisualizerType === 7) {
                // Triangoli
                for (let i = 0; i < 15; i++) {
                    const triangle = document.createElement('div');
                    triangle.className = 'visualizer-triangle';
                    triangle.style.left = `${Math.random() * 100}%`;
                    triangle.style.top = `${Math.random() * 100}%`;
                    triangle.style.borderBottomColor = `hsl(${Math.random() * 360}, 100%, 65%)`;
                    visualizer.appendChild(triangle);
                }
            } else if (currentVisualizerType === 8) {
                // Punti casuali
                for (let i = 0; i < 60; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'visualizer-dot';
                    dot.style.left = `${Math.random() * 100}%`;
                    dot.style.top = `${Math.random() * 100}%`;
                    dot.style.background = `hsl(${Math.random() * 360}, 100%, 65%)`;
                    visualizer.appendChild(dot);
                }
            } else if (currentVisualizerType === 9) {
                // Anelli
                for (let i = 0; i < 12; i++) {
                    const ring = document.createElement('div');
                    ring.className = 'visualizer-ring';
                    ring.style.left = `${Math.random() * 100}%`;
                    ring.style.top = `${Math.random() * 100}%`;
                    ring.style.borderColor = `hsl(${Math.random() * 360}, 100%, 65%)`;
                    visualizer.appendChild(ring);
                }
            } else if (currentVisualizerType === 10) {
                // Spirale
                for (let i = 0; i < 30; i++) {
                    const spiral = document.createElement('div');
                    spiral.className = 'visualizer-spiral';
                    spiral.style.left = '50%';
                    spiral.style.top = '50%';
                    spiral.style.background = `hsl(${i * 12}, 100%, 65%)`;
                    visualizer.appendChild(spiral);
                }
            } else if (currentVisualizerType === 11) {
                // Archi
                for (let i = 0; i < 18; i++) {
                    const arc = document.createElement('div');
                    arc.className = 'visualizer-arc';
                    arc.style.left = `${Math.random() * 100}%`;
                    arc.style.top = `${Math.random() * 100}%`;
                    arc.style.borderTopColor = `hsl(${Math.random() * 360}, 100%, 65%)`;
                    visualizer.appendChild(arc);
                }
            } else if (currentVisualizerType === 12) {
                // Esagoni
                for (let i = 0; i < 15; i++) {
                    const hexagon = document.createElement('div');
                    hexagon.className = 'visualizer-hexagon';
                    hexagon.style.left = `${Math.random() * 100}%`;
                    hexagon.style.top = `${Math.random() * 100}%`;
                    hexagon.style.background = `hsl(${Math.random() * 360}, 100%, 65%)`;
                    visualizer.appendChild(hexagon);
                }
            } else if (currentVisualizerType === 13) {
                // Diamanti
                for (let i = 0; i < 20; i++) {
                    const diamond = document.createElement('div');
                    diamond.className = 'visualizer-diamond';
                    diamond.style.left = `${Math.random() * 100}%`;
                    diamond.style.top = `${Math.random() * 100}%`;
                    diamond.style.background = `hsl(${Math.random() * 360}, 100%, 65%)`;
                    visualizer.appendChild(diamond);
                }
            } else if (currentVisualizerType === 14) {
                // Stelle
                for (let i = 0; i < 10; i++) {
                    const star = document.createElement('div');
                    star.className = 'visualizer-star';
                    star.style.left = `${Math.random() * 100}%`;
                    star.style.top = `${Math.random() * 100}%`;
                    star.style.background = `hsl(${Math.random() * 360}, 100%, 65%)`;
                    visualizer.appendChild(star);
                }
            } else if (currentVisualizerType === 15) {
                // Pulsazioni
                for (let i = 0; i < 25; i++) {
                    const pulse = document.createElement('div');
                    pulse.className = 'visualizer-pulse';
                    pulse.style.left = `${Math.random() * 100}%`;
                    pulse.style.top = `${Math.random() * 100}%`;
                    pulse.style.background = `hsl(${Math.random() * 360}, 100%, 65%)`;
                    visualizer.appendChild(pulse);
                }
            } else if (currentVisualizerType === 16) {
                // Griglia
                for (let i = 0; i < 8; i++) {
                    for (let j = 0; j < 6; j++) {
                        const grid = document.createElement('div');
                        grid.className = 'visualizer-grid';
                        grid.style.left = `${(i / 8) * 100}%`;
                        grid.style.top = `${(j / 6) * 100}%`;
                        grid.style.background = `hsl(${Math.random() * 360}, 100%, 65%)`;
                        visualizer.appendChild(grid);
                    }
                }
            } else if (currentVisualizerType === 17) {
                // Radiale
                const radial = document.createElement('div');
                radial.className = 'visualizer-radial';
                for (let i = 0; i < 24; i++) {
                    const line = document.createElement('div');
                    line.className = 'visualizer-radial-line';
                    line.style.transform = `rotate(${i * 15}deg)`;
                    line.style.height = '10px';
                    radial.appendChild(line);
                }
                visualizer.appendChild(radial);
            } else if (currentVisualizerType === 18) {
                // Matrice
                for (let i = 0; i < 10; i++) {
                    for (let j = 0; j < 8; j++) {
                        const matrix = document.createElement('div');
                        matrix.className = 'visualizer-matrix';
                        matrix.style.left = `${(i / 10) * 100}%`;
                        matrix.style.top = `${(j / 8) * 100}%`;
                        matrix.style.background = `hsl(${Math.random() * 360}, 100%, 65%)`;
                        visualizer.appendChild(matrix);
                    }
                }
            } else if (currentVisualizerType === 19) {
                // Vortice
                for (let i = 0; i < 40; i++) {
                    const vortex = document.createElement('div');
                    vortex.className = 'visualizer-vortex';
                    vortex.style.left = '50%';
                    vortex.style.top = '50%';
                    vortex.style.background = `hsl(${i * 9}, 100%, 65%)`;
                    visualizer.appendChild(vortex);
                }
            } else if (currentVisualizerType === 20) {
                // Onde circolari
                for (let i = 0; i < 8; i++) {
                    const ripple = document.createElement('div');
                    ripple.className = 'visualizer-ripple';
                    ripple.style.left = '50%';
                    ripple.style.top = '50%';
                    ripple.style.borderColor = `hsl(${i * 45}, 100%, 65%)`;
                    visualizer.appendChild(ripple);
                }
            } else if (currentVisualizerType === 21) {
                // Fuochi d'artificio
                for (let i = 0; i < 50; i++) {
                    const firework = document.createElement('div');
                    firework.className = 'visualizer-firework';
                    firework.style.left = `${Math.random() * 100}%`;
                    firework.style.top = `${Math.random() * 100}%`;
                    firework.style.background = `hsl(${Math.random() * 360}, 100%, 65%)`;
                    visualizer.appendChild(firework);
                }
            } else if (currentVisualizerType === 22) {
                // Nebulosa
                const nebula = document.createElement('div');
                nebula.className = 'visualizer-nebula';
                visualizer.appendChild(nebula);
                for (let i = 0; i < 30; i++) {
                    const star = document.createElement('div');
                    star.className = 'visualizer-dot';
                    star.style.left = `${Math.random() * 100}%`;
                    star.style.top = `${Math.random() * 100}%`;
                    star.style.background = `hsl(${Math.random() * 60 + 300}, 100%, 65%)`;
                    star.style.width = `${2 + Math.random() * 4}px`;
                    star.style.height = star.style.width;
                    visualizer.appendChild(star);
                }
            } else if (currentVisualizerType === 23) {
                // Scia
                for (let i = 0; i < 25; i++) {
                    const trail = document.createElement('div');
                    trail.className = 'visualizer-dot';
                    trail.style.left = `${Math.random() * 100}%`;
                    trail.style.top = `${Math.random() * 100}%`;
                    trail.style.background = `hsl(${Math.random() * 360}, 100%, 65%)`;
                    trail.style.width = `${3 + Math.random() * 5}px`;
                    trail.style.height = trail.style.width;
                    visualizer.appendChild(trail);
                }
            } else if (currentVisualizerType === 24) {
                // Cascata
                for (let i = 0; i < 20; i++) {
                    const waterfall = document.createElement('div');
                    waterfall.className = 'visualizer-bar';
                    waterfall.style.width = '15px';
                    waterfall.style.height = '5px';
                    waterfall.style.background = `hsl(${Math.random() * 60 + 200}, 100%, 65%)`;
                    visualizer.appendChild(waterfall);
                }
            }
        }

        // Avvia l'animazione del visualizzatore
        function startVisualizer() {
            if (visualizerAnimationId) {
                cancelAnimationFrame(visualizerAnimationId);
            }
            
            function animate() {
                if (!isPlaying) {
                    visualizerContainer.style.display = 'none';
                    return;
                }
                
                if (currentVisualizerType === 0) {
                    // Animazione barre
                    const bars = visualizer.querySelectorAll('.visualizer-bar');
                    bars.forEach(bar => {
                        const height = 5 + Math.random() * 70;
                        bar.style.height = `${height}px`;
                    });
                } else if (currentVisualizerType === 1) {
                    // Animazione cerchi
                    const circles = visualizer.querySelectorAll('.visualizer-circle');
                    circles.forEach(circle => {
                        const scale = 0.5 + Math.random() * 1.5;
                        circle.style.transform = `scale(${scale})`;
                        circle.style.opacity = 0.5 + Math.random() * 0.5;
                    });
                } else if (currentVisualizerType === 2) {
                    // Animazione onde
                    const waves = visualizer.querySelectorAll('.visualizer-wave');
                    const time = Date.now() / 1000;
                    waves.forEach((wave, i) => {
                        const speed = 0.5 + i * 0.2;
                        const offset = Math.sin(time * speed) * 20;
                        wave.style.transform = `translateX(${offset}px)`;
                    });
                } else if (currentVisualizerType === 3) {
                    // Animazione particelle
                    const particles = visualizer.querySelectorAll('.visualizer-particle');
                    particles.forEach(particle => {
                        let bottom = parseFloat(particle.style.bottom) || 0;
                        bottom += Math.random() * 3;
                        
                        if (bottom > 100) {
                            bottom = 0;
                            particle.style.left = `${Math.random() * 100}%`;
                        }
                        
                        particle.style.bottom = `${bottom}%`;
                        particle.style.opacity = 0.3 + (bottom / 100) * 0.7;
                    });
                } else if (currentVisualizerType === 4) {
                    // Animazione spectrum
                    const spectrum = visualizer.querySelector('.visualizer-spectrum');
                    const height = 10 + Math.random() * 80;
                    spectrum.style.height = `${height}%`;
                } else if (currentVisualizerType === 5) {
                    // Linee orizzontali
                    const lines = visualizer.querySelectorAll('.visualizer-line');
                    lines.forEach(line => {
                        const scale = 0.1 + Math.random() * 0.9;
                        line.style.transform = `scaleX(${scale})`;
                    });
                } else if (currentVisualizerType === 6) {
                    // Quadrati
                    const squares = visualizer.querySelectorAll('.visualizer-square');
                    squares.forEach(square => {
                        const scale = 0.5 + Math.random() * 1.5;
                        square.style.transform = `scale(${scale})`;
                        square.style.opacity = 0.3 + Math.random() * 0.7;
                    });
                } else if (currentVisualizerType === 7) {
                    // Triangoli
                    const triangles = visualizer.querySelectorAll('.visualizer-triangle');
                    triangles.forEach(triangle => {
                        const rotate = Math.random() * 360;
                        triangle.style.transform = `rotate(${rotate}deg)`;
                        triangle.style.opacity = 0.3 + Math.random() * 0.7;
                    });
                } else if (currentVisualizerType === 8) {
                    // Punti casuali
                    const dots = visualizer.querySelectorAll('.visualizer-dot');
                    dots.forEach(dot => {
                        const opacity = 0.1 + Math.random() * 0.9;
                        dot.style.opacity = opacity;
                    });
                } else if (currentVisualizerType === 9) {
                    // Anelli
                    const rings = visualizer.querySelectorAll('.visualizer-ring');
                    rings.forEach(ring => {
                        const scale = 0.5 + Math.random() * 1.5;
                        ring.style.transform = `scale(${scale})`;
                        ring.style.opacity = 0.3 + Math.random() * 0.7;
                    });
                } else if (currentVisualizerType === 10) {
                    // Spirale
                    const spirals = visualizer.querySelectorAll('.visualizer-spiral');
                    const time = Date.now() / 1000;
                    spirals.forEach((spiral, i) => {
                        const angle = time * 2 + i * 0.2;
                        const distance = 10 + i * 2;
                        const x = 50 + Math.cos(angle) * distance;
                        const y = 50 + Math.sin(angle) * distance;
                        spiral.style.left = `${x}%`;
                        spiral.style.top = `${y}%`;
                    });
                } else if (currentVisualizerType === 11) {
                    // Archi
                    const arcs = visualizer.querySelectorAll('.visualizer-arc');
                    arcs.forEach(arc => {
                        const rotate = Math.random() * 360;
                        arc.style.transform = `rotate(${rotate}deg)`;
                        arc.style.opacity = 0.3 + Math.random() * 0.7;
                    });
                } else if (currentVisualizerType === 12) {
                    // Esagoni
                    const hexagons = visualizer.querySelectorAll('.visualizer-hexagon');
                    hexagons.forEach(hexagon => {
                        const rotate = Math.random() * 360;
                        hexagon.style.transform = `rotate(${rotate}deg)`;
                        hexagon.style.opacity = 0.3 + Math.random() * 0.7;
                    });
                } else if (currentVisualizerType === 13) {
                    // Diamanti
                    const diamonds = visualizer.querySelectorAll('.visualizer-diamond');
                    diamonds.forEach(diamond => {
                        const scale = 0.5 + Math.random() * 1.5;
                        diamond.style.transform = `rotate(45deg) scale(${scale})`;
                        diamond.style.opacity = 0.3 + Math.random() * 0.7;
                    });
                } else if (currentVisualizerType === 14) {
                    // Stelle
                    const stars = visualizer.querySelectorAll('.visualizer-star');
                    stars.forEach(star => {
                        const scale = 0.5 + Math.random() * 1.5;
                        star.style.transform = `scale(${scale})`;
                        star.style.opacity = 0.3 + Math.random() * 0.7;
                    });
                } else if (currentVisualizerType === 15) {
                    // Pulsazioni
                    const pulses = visualizer.querySelectorAll('.visualizer-pulse');
                    const time = Date.now() / 500;
                    pulses.forEach((pulse, i) => {
                        const scale = 0.5 + Math.sin(time + i * 0.5) * 0.5;
                        pulse.style.transform = `scale(${scale})`;
                        pulse.style.opacity = 0.3 + scale * 0.7;
                    });
                } else if (currentVisualizerType === 16) {
                    // Griglia
                    const grids = visualizer.querySelectorAll('.visualizer-grid');
                    grids.forEach(grid => {
                        const scale = 0.5 + Math.random() * 1.5;
                        grid.style.transform = `scale(${scale})`;
                        grid.style.opacity = 0.3 + Math.random() * 0.7;
                    });
                } else if (currentVisualizerType === 17) {
                    // Radiale
                    const lines = visualizer.querySelectorAll('.visualizer-radial-line');
                    lines.forEach((line, i) => {
                        const height = 10 + Math.random() * 40;
                        line.style.height = `${height}px`;
                    });
                } else if (currentVisualizerType === 18) {
                    // Matrice
                    const matrices = visualizer.querySelectorAll('.visualizer-matrix');
                    matrices.forEach(matrix => {
                        const scale = 0.5 + Math.random() * 1.5;
                        matrix.style.transform = `scale(${scale})`;
                        matrix.style.opacity = 0.3 + Math.random() * 0.7;
                    });
                } else if (currentVisualizerType === 19) {
                    // Vortice
                    const vortices = visualizer.querySelectorAll('.visualizer-vortex');
                    const time = Date.now() / 1000;
                    vortices.forEach((vortex, i) => {
                        const angle = time * 3 + i * 0.3;
                        const distance = 5 + i * 1.5;
                        const x = 50 + Math.cos(angle) * distance;
                        const y = 50 + Math.sin(angle) * distance;
                        vortex.style.left = `${x}%`;
                        vortex.style.top = `${y}%`;
                    });
                } else if (currentVisualizerType === 20) {
                    // Onde circolari
                    const ripples = visualizer.querySelectorAll('.visualizer-ripple');
                    const time = Date.now() / 1000;
                    ripples.forEach((ripple, i) => {
                        const scale = 1 + i * 0.5 + Math.sin(time * 2) * 0.5;
                        ripple.style.transform = `scale(${scale})`;
                        ripple.style.opacity = 0.7 - i * 0.1;
                    });
                } else if (currentVisualizerType === 21) {
                    // Fuochi d'artificio
                    const fireworks = visualizer.querySelectorAll('.visualizer-firework');
                    fireworks.forEach(firework => {
                        let top = parseFloat(firework.style.top) || 0;
                        top -= Math.random() * 2;
                        
                        if (top < 0) {
                            top = 100;
                            firework.style.left = `${Math.random() * 100}%`;
                        }
                        
                        firework.style.top = `${top}%`;
                        firework.style.opacity = 0.3 + (top / 100) * 0.7;
                    });
                } else if (currentVisualizerType === 22) {
                    // Nebulosa
                    const dots = visualizer.querySelectorAll('.visualizer-dot');
                    dots.forEach(dot => {
                        const pulse = 0.3 + Math.sin(Date.now() / 1000 + Math.random() * 10) * 0.3;
                        dot.style.opacity = pulse;
                    });
                } else if (currentVisualizerType === 23) {
                    // Scia
                    const trails = visualizer.querySelectorAll('.visualizer-dot');
                    trails.forEach(trail => {
                        let left = parseFloat(trail.style.left) || 0;
                        left += (Math.random() - 0.5) * 2;
                        
                        if (left < 0) left = 0;
                        if (left > 100) left = 100;
                        
                        trail.style.left = `${left}%`;
                        trail.style.opacity = 0.2 + Math.random() * 0.8;
                    });
                } else if (currentVisualizerType === 24) {
                    // Cascata
                    const waterfalls = visualizer.querySelectorAll('.visualizer-bar');
                    waterfalls.forEach(waterfall => {
                        let height = parseFloat(waterfall.style.height) || 5;
                        height += (Math.random() - 0.5) * 10;
                        
                        if (height < 5) height = 5;
                        if (height > 80) height = 80;
                        
                        waterfall.style.height = `${height}px`;
                    });
                }
                
                visualizerAnimationId = requestAnimationFrame(animate);
            }
            
            visualizerContainer.style.display = 'block';
            animate();
        }

        // Ferma il visualizzatore
        function stopVisualizer() {
            if (visualizerAnimationId) {
                cancelAnimationFrame(visualizerAnimationId);
                visualizerAnimationId = null;
            }
            visualizerContainer.style.display = 'none';
        }

        // Cambia tipo di visualizzatore
        function changeVisualizerType() {
            currentVisualizerType = (currentVisualizerType + 1) % visualizerTypes;
            initVisualizer();
            if (isPlaying) {
                startVisualizer();
            }
        }

        // Funzione per ottenere il brano in riproduzione
        async function getNowPlaying() {
            if (!currentStation) return;
            
            try {
                // Prova diverse API per ottenere le informazioni sul brano
                const stationUuid = currentStation.stationuuid;
                
                // API Radio Browser per le informazioni della stazione
                const response = await fetch(`https://de1.api.radio-browser.info/json/stations/byuuid/${stationUuid}`);
                const stationInfo = await response.json();
                
                if (stationInfo && stationInfo[0]) {
                    const station = stationInfo[0];
                    
                    // Controlla se ci sono informazioni sul brano corrente
                    if (station.lastcheckok) {
                        // Alcune stazioni forniscono il brano corrente via API
                        const nowPlayingResponse = await fetch(`https://de1.api.radio-browser.info/json/stations/byuuid/${stationUuid}`);
                        const nowPlayingData = await nowPlayingResponse.json();
                        
                        if (nowPlayingData && nowPlayingData[0] && nowPlayingData[0].lastchangetime) {
                            const lastUpdate = new Date(nowPlayingData[0].lastchangetime);
                            const now = new Date();
                            const diffMinutes = (now - lastUpdate) / (1000 * 60);
                            
                            // Se l'aggiornamento √® recente (meno di 10 minuti), mostra il brano
                            if (diffMinutes < 10 && nowPlayingData[0].lastchangetitle) {
                                nowPlayingEl.textContent = `üéµ ${nowPlayingData[0].lastchangetitle}`;
                                return;
                            }
                        }
                    }
                    
                    // Fallback: mostra informazioni generiche
                    if (station.tags) {
                        const tags = station.tags.split(',').slice(0, 2).join(', ');
                        nowPlayingEl.textContent = `üéµ ${tags}`;
                    } else {
                        nowPlayingEl.textContent = 'üéµ Informazioni brano non disponibili';
                    }
                }
            } catch (error) {
                console.log('Errore nel recupero informazioni brano:', error);
                nowPlayingEl.textContent = 'üéµ Caricamento informazioni...';
            }
        }

        // Imposta volume iniziale
        audio.volume = volumeSlider.value;

        // Funzione per caricare stazioni con paginazione
        async function loadStationsBatch(offset = 0, limit = BATCH_SIZE, query = '') {
            if (isLoading) return [];
            
            isLoading = true;
            statusEl.textContent = `Caricamento stazioni ${offset + 1}-${offset + limit}...`;
            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = 'üîç+';

            try {
                const baseUrl = 'https://de1.api.radio-browser.info/json/stations/search';
                const params = new URLSearchParams({
                    limit: limit.toString(),
                    offset: offset.toString(),
                    hidebroken: 'true'
                });

                if (query) {
                    params.append('name', query);
                }

                const response = await fetch(`${baseUrl}?${params}`);
                
                if (!response.ok) {
                    throw new Error(`Errore HTTP: ${response.status}`);
                }
                
                const stations = await response.json();
                
                // Filtra stazioni duplicate per UUID
                const newStations = stations.filter(newStation => 
                    !allStations.some(existingStation => 
                        existingStation.stationuuid === newStation.stationuuid
                    )
                );

                allStations = [...allStations, ...newStations];
                loadedCount = allStations.length;

                // Aggiorna UI
                updateStationCounter();
                displayStations(newStations);
                
                statusEl.textContent = `Caricate ${newStations.length} stazioni`;
                
                return newStations;

            } catch (error) {
                console.error('Errore nel caricamento:', error);
                statusEl.textContent = `Errore: ${error.message}`;
                return [];
            } finally {
                isLoading = false;
                loadMoreBtn.disabled = false;
                loadMoreBtn.textContent = 'üîç+';
            }
        }

        // Funzione per caricamento iniziale
        async function loadInitialStations() {
            statusEl.textContent = 'Caricamento stazioni iniziali...';
            
            // Carica pi√π batch iniziali per partire con un buon numero
            const initialBatches = 5;
            let loaded = 0;
            
            for (let i = 0; i < initialBatches && loaded < TARGET_STATIONS; i++) {
                const newStations = await loadStationsBatch(currentOffset, BATCH_SIZE);
                currentOffset += BATCH_SIZE;
                loaded += newStations.length;
                
                // Piccola pausa tra le richieste per non sovraccaricare il server
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            statusEl.textContent = `Caricate ${loaded} stazioni iniziali. Usa la ricerca o carica pi√π stazioni.`;
        }

        // Funzione per caricare pi√π stazioni
        async function loadMoreStations() {
            if (isLoading || loadedCount >= TARGET_STATIONS) return;
            
            const newStations = await loadStationsBatch(currentOffset, BATCH_SIZE, currentSearchQuery);
            currentOffset += BATCH_SIZE;
            
            if (newStations.length === 0) {
                statusEl.textContent = 'Nessuna altra stazione trovata';
                loadMoreBtn.disabled = true;
                loadMoreBtn.textContent = 'üîç+';
            }
        }

        // Funzione per aggiornare il contatore
        function updateStationCounter() {
            stationCountEl.textContent = loadedCount;
            const progress = (loadedCount / TARGET_STATIONS) * 100;
            progressBar.style.width = `${progress}%`;
            
            if (loadedCount >= TARGET_STATIONS) {
                loadMoreBtn.disabled = true;
                loadMoreBtn.textContent = 'üîç+';
                statusEl.textContent = 'Complimenti! Hai raggiunto 10000 stazioni!';
            }
        }

        // Funzione per visualizzare le stazioni
        function displayStations(stations) {
            stations.forEach(station => {
                // Controlla se questa stazione √® gi√† nella lista
                const existingItem = stationList.querySelector(`[data-uuid="${station.stationuuid}"]`);
                if (existingItem) return;
                
                const stationItem = document.createElement('div');
                stationItem.className = 'station-item';
                stationItem.dataset.uuid = station.stationuuid;
                
                stationItem.innerHTML = `
                    <div class="station-item-info">
                        <div class="station-item-name">${station.name}</div>
                        <div class="station-item-details">
                            ${station.country || 'N/A'} ‚Ä¢ ${station.tags?.split(',')[0] || 'No tags'} ‚Ä¢ 
                            ${station.bitrate || 'N/A'}kbps
                        </div>
                    </div>
                `;
                
                stationItem.addEventListener('click', () => {
                    selectStation(station);
                });
                
                stationList.appendChild(stationItem);
            });
        }

        // Funzione per selezionare una stazione
        function selectStation(station) {
            currentStation = station;
            stationName.textContent = station.name;
            stationDetails.textContent = `${station.country || 'N/A'} ‚Ä¢ ${station.tags?.split(',')[0] || 'No tags'}`;
            statusEl.textContent = 'Preparazione...';
            nowPlayingEl.textContent = '';
            
            audio.pause();
            isPlaying = false;
            playPauseBtn.textContent = '‚ñ∂';
            playPauseBtn.disabled = false;
            stopBtn.disabled = false;
            stopVisualizer();
            
            // Ferma eventuali intervalli precedenti
            if (nowPlayingInterval) {
                clearInterval(nowPlayingInterval);
            }
            
            playStation();
        }

        // Funzione per riprodurre la stazione
        function playStation() {
            if (!currentStation) return;
            
            const streamUrl = currentStation.url_resolved || currentStation.url;
            audio.src = streamUrl;
            
            audio.play().then(() => {
                isPlaying = true;
                playPauseBtn.textContent = '‚è∏';
                statusEl.textContent = 'In riproduzione';
                startVisualizer();
                
                // Avvia il polling per le informazioni sul brano
                getNowPlaying();
                nowPlayingInterval = setInterval(getNowPlaying, 30000); // Aggiorna ogni 30 secondi
                
                // Registra il click per le statistiche
                recordStationClick(currentStation.stationuuid);
            }).catch(error => {
                console.error('Errore nella riproduzione:', error);
                statusEl.textContent = 'Errore: stream non supportato';
                isPlaying = false;
                playPauseBtn.textContent = '‚ñ∂';
                stopVisualizer();
            });
        }

        // Funzione per fermare completamente la riproduzione
        function stopPlayback() {
            audio.pause();
            audio.src = '';
            isPlaying = false;
            playPauseBtn.textContent = '‚ñ∂';
            statusEl.textContent = 'Fermato';
            nowPlayingEl.textContent = '';
            stopVisualizer();
            
            // Ferma il polling per le informazioni sul brano
            if (nowPlayingInterval) {
                clearInterval(nowPlayingInterval);
                nowPlayingInterval = null;
            }
            
            currentStation = null;
            stationName.textContent = 'Seleziona una stazione';
            stationDetails.textContent = 'Riproduzione fermata';
        }

        // Funzione per registrare i click (per le statistiche Radio Browser)
        async function recordStationClick(stationUuid) {
            try {
                await fetch(`https://de1.api.radio-browser.info/json/url/${stationUuid}`, {
                    method: 'POST'
                });
            } catch (error) {
                console.log('Statistica non registrata:', error);
            }
        }

        // Ricerca stazioni
        let searchTimeout;
        function handleSearch(query) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                if (query.length >= 2) {
                    // Ricerca specifica
                    currentSearchQuery = query;
                    currentOffset = 0;
                    allStations = [];
                    stationList.innerHTML = '';
                    await loadStationsBatch(0, 1000, query);
                } else if (query.length === 0) {
                    // Ritorna al caricamento normale
                    currentSearchQuery = '';
                    currentOffset = 0;
                    allStations = [];
                    stationList.innerHTML = '';
                    await loadInitialStations();
                }
            }, 800);
        }

        // Event listeners
        playPauseBtn.addEventListener('click', () => {
            if (!currentStation && allStations.length > 0) {
                selectStation(allStations[0]);
                return;
            }
            
            if (isPlaying) {
                audio.pause();
                isPlaying = false;
                playPauseBtn.textContent = '‚ñ∂';
                statusEl.textContent = 'In pausa';
                stopVisualizer();
            } else {
                playStation();
            }
        });

        stopBtn.addEventListener('click', () => {
            stopPlayback();
        });

        volumeSlider.addEventListener('input', (e) => {
            audio.volume = e.target.value;
        });

        loadMoreBtn.addEventListener('click', loadMoreStations);

        searchInput.addEventListener('input', (e) => {
            handleSearch(e.target.value.trim());
        });
        
        // Click sul visualizzatore per cambiare tipo
        visualizerContainer.addEventListener('click', changeVisualizerType);

        // Gestione errori audio
        audio.addEventListener('error', (e) => {
            console.error('Errore audio:', e);
            statusEl.textContent = 'Errore: stream non supportato';
            isPlaying = false;
            playPauseBtn.textContent = '‚ñ∂';
            stopVisualizer();
        });

        // Inizializzazione
        initVisualizer();
        loadInitialStations();
    </script>
</body>
</html>
